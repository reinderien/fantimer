#LyX 2.3 created this file. For more info see http://www.lyx.org/
\lyxformat 544
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass article
\use_default_options true
\maintain_unincluded_children false
\language canadian
\language_package default
\inputencoding auto
\fontencoding global
\font_roman "default" "default"
\font_sans "default" "default"
\font_typewriter "default" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\use_microtype false
\use_dash_ligatures true
\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks false
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize default
\use_geometry true
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine basic
\cite_engine_type default
\biblio_style plain
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 1
\use_minted 0
\index Index
\shortcut idx
\color #008000
\end_index
\leftmargin 2cm
\topmargin 2cm
\rightmargin 2cm
\bottommargin 2cm
\secnumdepth 3
\tocdepth 3
\paragraph_separation indent
\paragraph_indentation default
\is_math_indent 0
\math_numbering_side default
\quotes_style english
\dynamic_quotes 0
\papercolumns 1
\papersides 1
\paperpagestyle default
\listings_params "basicstyle={\ttfamily}"
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
A simple, automatic timed mains switch
\end_layout

\begin_layout Author
Greg Toombs (820021)
\end_layout

\begin_layout Section
Motivation
\end_layout

\begin_layout Standard
This project has been completed to satisfy the continuing professional developme
nt (CPD) requirements to retain CET (Certified Engineering Technologist)
 status with the Ontario Association of Certified Engineering Technicians
 and Technologists (OACETT).
 According to OACETT,
\end_layout

\begin_layout Quote
Mandatory CPD will be introduced for most members beginning January 1, 2016.
 [...] The Continuing Professional Development applies to all certified members
 (working full- or part-time), including Life and Fellow OACETT categories.
 Associates admitted to membership prior to July 2005 are required to complete
 continuing professional development as well.
\begin_inset CommandInset citation
LatexCommand cite
key "cpd"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
Under the CPD policy, members can stay compliant if they undergo at least
 one full day per three-year cycle of self-directed study.
\begin_inset CommandInset citation
LatexCommand cite
key "comply"
literal "false"

\end_inset

 This project, having taken two weeks of part-time self-directed study and
 falling under the category of 
\begin_inset Quotes eld
\end_inset

Contributions to Technical Knowledge
\begin_inset Quotes erd
\end_inset

, should satisfy these requirements.
 Study has included topics such as mains line switching, protection and
 safety; and detailed analysis of optoisolation technologies.
\end_layout

\begin_layout Section
Overview
\end_layout

\begin_layout Standard
The device being designed is a timed switch.
 It is intended for residential installation to control a fan in a washroom.
 It is designed to retrofit an existing light switch, to be installed behind
 drywall in the same electrical box (or an adjacent electrical box, depending
 on available space).
 When the light switch turns on, the timer turns on the fan; when the light
 switch turns off, the timer continues to run the fan for an additional
 amount of time configurable by an on-board potentiometer.
\end_layout

\begin_layout Standard
The timer is intended to be simple, safe, and low-cost.
 It does not have any user-accessible controls once the box has been closed.
 Potential applications include a rental property where the owner needs
 some assurance that the fan will reduce mould risk in an environment prone
 to humidity.
\end_layout

\begin_layout Standard
To simplify prototyping, all parts chosen are through-hole, to be soldered
 to a through-hole perforated prototype board (
\begin_inset Quotes eld
\end_inset

perfboard
\begin_inset Quotes erd
\end_inset

).
 This eliminates the need for a custom printed circuit board (PCB).
 Hand soldering is feasible due to the low number of component connections.
\end_layout

\begin_layout Subsection
Parts Vendor
\begin_inset CommandInset label
LatexCommand label
name "subsec:vendor"

\end_inset


\end_layout

\begin_layout Standard
To again simplify prototyping, Digi-KeyÂ® is used as the sole vendor for
 parts, for several reasons: they have a huge variety of products, a fast
 shipping service 
\begin_inset CommandInset citation
LatexCommand cite
key "dk-shipping"
literal "false"

\end_inset

, and a fairly good search interface.
 Some standard criteria are used to select parts that will be inexpensive,
 readily available, and useful for this project:
\end_layout

\begin_layout Itemize
Stock Status: In Stock
\end_layout

\begin_layout Itemize
Part Status: Active
\end_layout

\begin_layout Itemize
Mounting Type: Through Hole
\end_layout

\begin_layout Itemize
Quantity (
\begin_inset Quotes eld
\end_inset

View Prices At
\begin_inset Quotes erd
\end_inset

) typically 2, so that products with a high minimum quantity are not shown
\end_layout

\begin_layout Itemize
Sort ascending by unit price, to choose the least expensive part that still
 meets criteria
\end_layout

\begin_layout Standard
If this product were to be converted to mass manufacturing, it may be more
 cost-effective to move to a different vendor, but that is not currently
 a factor.
\end_layout

\begin_layout Section
Safety Considerations
\end_layout

\begin_layout Standard
As in all electrical design, safety must be the top priority.
 Safety applies both to the technologist assembling and testing the circuit,
 as well as the end user.
\end_layout

\begin_layout Subsection
Lab Safety
\end_layout

\begin_layout Standard
When testing and installing circuits that operate at 120V, the following
 precautions must be observed:
\end_layout

\begin_layout Itemize
The lab must have a working breaker or fuse.
 If possible, power the circuit through a ground-fault circuit interrupter
 (GFCI).
\end_layout

\begin_layout Itemize
Have a local switch to disable mains power to the circuit during wiring
 work.
 Never rewire or otherwise touch the circuit unless the mains are de-energized.
\end_layout

\begin_layout Itemize
Keep a clean and uncluttered workspace.
 Only have on hand the tools and parts needed.
 Remove any unneeded conductors that could cause unintentional shorts.
\end_layout

\begin_layout Itemize
The work surface must be non-conductive.
 Ideally, an electrostatic dissipation (ESD) mat with a grounding line should
 be used.
\end_layout

\begin_layout Itemize
Do not wear any metal jewellery, watches, or accessories that might cause
 unintentional shorts.
\end_layout

\begin_layout Itemize
Before energizing any high-voltage circuits, always do a cursory inspection
 of the circuit to check for faults.
\end_layout

\begin_layout Itemize
When using testing equipment (e.g.
 multimeter, oscilloscope), take care to select an appropriate range setting.
\end_layout

\begin_layout Itemize
Always have at least one other person on the premises in case of emergency.
 At least one person on the premises must have first-aid training.
\end_layout

\begin_layout Subsection
Circuit Safety
\begin_inset CommandInset label
LatexCommand label
name "subsec:circuit-safety"

\end_inset


\end_layout

\begin_layout Standard
Detection of the light switch status should be done with a circuit isolated
 from mains voltage; a simple and safe option is an optoisolator (
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:opto-input"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 The board power supply and the output switch should also be isolated from
 mains voltage (sections 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:supply"
plural "true"
caps "false"
noprefix "false"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:fan-output"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
\end_layout

\begin_layout Standard
The enclosure is not described in this document, but should either be metal
 with a connection to earth ground, or plastic (typically ABS).
 The perfboard has mounting holes on its corners.
 A bolt should run through each hole and through plastic stand-off sleeves
 to prevent contact between the circuit and the enclosure.
\end_layout

\begin_layout Standard
When running wire between solder pads, only strip the necessary amount of
 insulator from the wire ends and no more.
 Trim excess component leads after soldering.
\end_layout

\begin_layout Standard
Exterior connections to the board use a terminal block with a compression
 screw, leaf spring and wire guard, for a secure and shielded connection.
 During installation, mains wires that are stripped should have insulator
 running right to the edge of the terminal block aperture so that any exposed
 copper is shielded by the terminal block.
 Any exterior connections to live mains lines should have fuses.
 The terminal block and adjoining fuses are described in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:mains-conn"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
The circuit should have some safety against surges.
 The board power supply has built-in surge protection.
 The optoisolator is preceded by a bidirectional-channel transient voltage
 suppression (TVS) diode and surge absorption resistors, described in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:opto-input"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
 The relay output is protected by a metal-oxide varistor (MOV) and not a
 TVS; this is described in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:fan-output"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
Whenever switching mains voltage (in this case, for the fan), always switch
 the live line, not the neutral line.
 The neutral line is bonded to earth ground upstream, so neutral voltage
 is close to earth voltage and is safer to use as a common/return than live.
 This strategy is used in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:fan-output"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Section
Design Tools
\end_layout

\begin_layout Subsection
Third-Party Software
\end_layout

\begin_layout Standard
Eagle (formerly of CadSoft, now Autodesk since 2016 
\begin_inset CommandInset citation
LatexCommand cite
key "ad-eats-eagle"
literal "false"

\end_inset

) is the electronic computer-aided design (ECAD) tool used.
 It is used for the wiring diagram, circuit schematic, and airwire board
 diagram.
\end_layout

\begin_layout Standard
Microchip Programmable Interrupt Controller (PICÂ®) Lab 
\begin_inset Quotes eld
\end_inset

MPLABÂ® X
\begin_inset Quotes erd
\end_inset

 is used for the embedded integrated development environment (IDE).
 It includes an editor, assembler, linker, driver for the PICkitâ¢ 3 programmer,
 and simulator, all used in this project.
\end_layout

\begin_layout Standard
The 
\begin_inset Quotes eld
\end_inset

Quite Universal Circuit Simulator
\begin_inset Quotes erd
\end_inset

 (QUCS) is used for simulating some analog portions of the timer circuit.
\end_layout

\begin_layout Standard
The project files are tracked by a version control system (VCS) called Git.
 Git is best-suited to saving a detailed history of textual files and their
 changes over time.
 As such, all of the files are saved in text format, including the bill
 of materials (BOM) spreadsheet.
 The BOM is saved as a Flat Open Document Format Spreadsheet (FODS) from
 LibreOffice, and is reproduced in appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:bom"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
All software used is free on the internet.
 QUCS, Git and LibreOffice are free open-source software (FOSS), but Eagle
 and MPLABX are proprietary.
\end_layout

\begin_layout Subsection
Third-Party Hardware
\end_layout

\begin_layout Standard
The digital storage oscilloscope (DSO) used is a low-cost open-source DS203
 from MiniDSO.
 Given the low bandwidth requirements and low complexity of this project,
 it is adequate.
\end_layout

\begin_layout Standard
The PIC programmer used is a Microchip PICkitâ¢ 3.
 It is used for in-circuit serial programming (ICSP) of the firmware, and
 although it supports in-circuit debugging (ICD), this is not feasible given
 the low pin count of the PIC.
\end_layout

\begin_layout Subsection
Custom Software
\end_layout

\begin_layout Standard
To help explore options for component selection, particularly for the passives
 before the optoisolator, a small tool has been written in Python.
 It iterates through possibilities for some resistors, capacitors and TVS
 breakdown voltages, constraining the resistors and capacitors to common
 values in the E24 and E12 series, respectively.
 For details see appendix 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:code-listing-elsel"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename schematic.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Circuit schematic.
\begin_inset CommandInset label
LatexCommand label
name "fig:schematic"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Analysis
\end_layout

\begin_layout Subsection
Mains Connections
\begin_inset CommandInset label
LatexCommand label
name "subsec:mains-conn"

\end_inset


\end_layout

\begin_layout Standard
The mains terminal block (X1 in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:schematic"
plural "false"
caps "false"
noprefix "false"

\end_inset

) needs four connections: neutral (
\begin_inset Quotes eld
\end_inset

AC/N
\begin_inset Quotes erd
\end_inset

), live from the source panel (
\begin_inset Quotes eld
\end_inset

AC/L
\begin_inset Quotes erd
\end_inset

), live from the light switch (
\begin_inset Quotes eld
\end_inset

LIVE_LIGHT
\begin_inset Quotes erd
\end_inset

), and live to the fan (
\begin_inset Quotes eld
\end_inset

LIVE_FAN
\begin_inset Quotes erd
\end_inset

).
 Since nearly all perfboards have a standard 100mil pitch, the most convenient
 block pitch to use is 200mil, which allows for a good balance between expense
 and wire size support.
 The part used actually has a pitch of 5mm, which is very close to 200mil:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left(5\textrm{mm}\right)\frac{100\textrm{mil}}{2.54\textrm{mm}}=196.85\textrm{mil}\approx200\textrm{mil}
\]

\end_inset


\end_layout

\begin_layout Standard
The terminal block leads are 1mm wide, which requires that the perfboard
 holes be slightly drilled out for this part.
\end_layout

\begin_layout Standard
The circuit requiring the highest current-carrying capacity is through the
 terminal block, between AC/L and LIVE_FAN.
 Most ceiling fans typically consume less than 100W, which implies current
 up to 100W/120V = 833mA.
 The WÃ¼rth 1377 series can carry 16A, and supports the connection style
 described in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:circuit-safety"
plural "false"
caps "false"
noprefix "false"

\end_inset

 
\begin_inset CommandInset citation
LatexCommand cite
key "term"
literal "false"

\end_inset

.
 The switch side of the relay can carry 15A 
\begin_inset CommandInset citation
LatexCommand cite
key "relay"
literal "false"

\end_inset

.
\end_layout

\begin_layout Standard
Both AC/L and LIVE_LIGHT should be fused.
 LIVE_FAN does not need to be fused because it is derived from AC/L.
 For LIVE_LIGHT, a ceramic positive temperature coefficient (CPTC) self-resettin
g fuse is used (F2 in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:schematic"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 For more details see 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:opto-input"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename fuse.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Time-to-open against current for the BelFuse 5MF series 
\begin_inset CommandInset citation
LatexCommand cite
key "fuses"
literal "false"

\end_inset


\begin_inset CommandInset label
LatexCommand label
name "fig:fuse-times"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
For AC/L, PTC fuses were considered, but for the current ranges needed,
 there is not a good selection, and the components are bulky, expensive
 and slow to trip.
 A filament fuse is used instead (F1 in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:schematic"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 The standard fuse form factor chosen is 5mm diameter by 20mm length, and
 the manufacturer chosen is Bel Fuse Inc.; they carry fast-response filament
 fuses over a wide current rating range.
 The fuse is held with two 5mm clips.
 Although the fan is not expected to draw over 833mA steady-state, motors
 typically have a surge current many times above that.
 For this reason, the chosen fuse is rated for 5A, and will trip in 1s with
 a current of about 9.5A (
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:fuse-times"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
\end_layout

\begin_layout Subsection
Supply
\begin_inset CommandInset label
LatexCommand label
name "subsec:supply"

\end_inset


\end_layout

\begin_layout Standard
The timer uses a 5V supply, U1 in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:schematic"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
 This is low enough to be compatible with microcontrollers in the Microchip
 PICÂ® series, but high enough to directly drive a relay coil.
 The simplest - though not necessarily the most cost-effective, nor physically
 smallest - style of supply is an integrated, enclosed unit such as the
 MeanWell IRM-01-5.
 This meets the isolation and surge requirements described in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:circuit-safety"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
This supply supports up to 200mA output 
\begin_inset CommandInset citation
LatexCommand cite
key "psu"
literal "false"

\end_inset

.
 The current drawn by all parts of the circuit other than the relay coil
 is negligible.
 The relay coil draws 71mA, well within the supply's rating.
\end_layout

\begin_layout Subsection
Line Detection
\end_layout

\begin_layout Standard
The analog section requiring the most detailed analysis is the line detection
 circuit.
 This circuit is designed not to directly measure the amount of voltage
 on the line, but simply to indicate to the timing microcontroller whether
 the light switch is on or not.
 As such, it has no linearity requirements.
\end_layout

\begin_layout Standard
The central component in the line detection circuit is the optoisolator.
 The only requirements are that the input be a pair of antiparallel LEDs
 for AC support, plus the vendor criteria (see 
\begin_inset CommandInset ref
LatexCommand nameref
reference "subsec:vendor"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 The Lite-On LTV-814H fits well.
\end_layout

\begin_layout Subsubsection
Optoisolator Input
\begin_inset CommandInset label
LatexCommand label
name "subsec:opto-input"

\end_inset


\end_layout

\begin_layout Standard
The input is 120Vac (170Vpk), but the forward voltage drop of the opto is
 only ~1.1V.
 During steady-state operation of the circuit, the majority of this voltage
 difference should be dropped by capacitance rather than resistance, to
 decrease power and heat output.
 The circuit should also include a TVS.
 Both the TVS and the opto should be preceded by an absorption impedance
 should there be an over-voltage event, but this impedance cannot be purely
 capacitive, as that would be invisible to transients; so there should be
 some minimum resistance.
 The resistance must also account for the worst-case input surge event,
 where the switch is closed at input cycle peak and the capacitors are uncharged.
\end_layout

\begin_layout Standard
For simplicity's sake â and to take advantage of economies of scale, should
 this be mass-manufactured â make the absorption resistors R1 and R2 equal
 to each other, and the voltage drop capacitors C1 and C2 also equal to
 each other.
 The TVS diode must then have a minimum breakdown voltage equal to the midpoint
 between the input and opto peak voltages, or
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
V_{mid}=\frac{(120\textrm{V})\sqrt{2}+1.1}{2}=85.4\textrm{V}\approx86.5\textrm{V}
\]

\end_inset


\end_layout

\begin_layout Standard
The TVS diode D2 can be assigned the Littelfuse P6KE91CA which has a Vbrmin=86.5V
 
\begin_inset CommandInset citation
LatexCommand cite
key "tvs"
literal "false"

\end_inset

.
\end_layout

\begin_layout Standard
The resistors must be chosen so that during input surge, they allow a current
 less than the maximum supported by the opto, 150mApk.
 Using a conservative 50mA,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
R_{1,2}=\frac{V_{mid}}{50\textrm{mA}}\approx1.6\textrm{k\ensuremath{\Omega}}
\]

\end_inset


\end_layout

\begin_layout Standard
The resistors chosen must support the surge power:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\frac{V_{mid}^{2}}{R}=4.5\textrm{W}\ll39\textrm{W}
\]

\end_inset


\end_layout

\begin_layout Standard
This surge power occurs for less than 1ms.
 The surge power derating curve for StackPole's affordable CF14 series (
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:derating"
plural "false"
caps "false"
noprefix "false"

\end_inset

) shows that, for 1ms, the CF14 (in blue) can tolerate ~39W; and it can
 tolerate 4.5W for over 100ms; so it is safe.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Graphics
	filename res-derating.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Surge power derating curve for the StackPole Electronics Carbon Film (CF)
 series of resistors 
\begin_inset CommandInset citation
LatexCommand cite
key "stackpole-cfres"
literal "false"

\end_inset


\begin_inset CommandInset label
LatexCommand label
name "fig:derating"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The resistors must also support a steady-state power dissipation based on
 the selected bias current for the opto input.
 If the bias current is 10mA peak, then the steady-state power is easily
 supported by an affordable quarter-watt resistor:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
P_{R}=\frac{(10\textrm{mA})^{2}\cdot1.6\textrm{k\Omega}}{2}=80\textrm{mW}\ll250\textrm{mW}
\]

\end_inset


\end_layout

\begin_layout Standard
F2 is a CPTC.
 Polymeric and ceramic fuses open the circuit during thermal overload from
 high current, and are able to recover after the short condition is removed.
 Ceramic fuses have a much faster response time than polymeric fuses.
 The chosen CPTC is the Bourns CMF-RL35-0 (
\begin_inset Quotes eld
\end_inset

ceramic fuse, radial lead, 35 ohms
\begin_inset Quotes erd
\end_inset

).
 The inline resistance is negligible compared to the 3.2k through the rest
 of the detector circuit.
 The hold current (the current below which the fuse will not trip) must
 exceed the maximum surge current of 50mA; the CMF-RL35-0 has an 
\begin_inset Formula $I_{hold}=75$
\end_inset

mA 
\begin_inset CommandInset citation
LatexCommand cite
key "cptc"
literal "false"

\end_inset

.
 It will trip after 150ms when the current exceeds 
\begin_inset Formula $I_{trip}=150$
\end_inset

mA, another way to ensure that the maximum opto input current is never exceeded.
\end_layout

\begin_layout Standard
The capacitors must drop the proper voltage during steady-state (non-surge)
 operation.
 Neglecting the forward drop of the opto,
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
V_{C}=\sqrt{V_{mid}^{2}-(10\textrm{mA}\cdot1.6\textrm{k\Omega})^{2}}=83.9\textrm{V}\ll160\textrm{V}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
C_{1,2}=\frac{10\textrm{mA}}{2\pi\cdot60\textrm{Hz}\cdot V_{C}}=316\textrm{nF}\approx330\textrm{nF}
\]

\end_inset


\end_layout

\begin_layout Standard
For high-voltage, mid-capacitance applications like this, metallized polyester-f
ilm capacitors are well-suited.
 The Illinois Capacitor MMR series offers a 330nF capacitor that can withstand
 160Vac, the 334MMR250K 
\begin_inset CommandInset citation
LatexCommand cite
key "illinois-cap"
literal "false"

\end_inset

.
\end_layout

\begin_layout Subsubsection
Optoisolator Output
\end_layout

\begin_layout Standard
The output of the optoisolator is an optical-base transistor, in this circuit
 configured for common emitter mode.
 High collector current severely impedes the performance of the transistor
 and increases saturation voltage, so it should be kept as low as possible.
 Rather than using a discrete resistor for load, the load can be the weak
 pull-up (WPU) resistance of a port on the PIC.
 With 
\begin_inset Formula $V_{DD}=5\textrm{V}$
\end_inset

 and T=25Â°C this is typically 22k (
\begin_inset CommandInset citation
LatexCommand cite
key "pic"
literal "false"

\end_inset

, p.
 56).
 Due to the way that the opto is biased, the transistor is nearly always
 in saturation except when the input crosses zero, going below the opto
 forward voltage drop: 
\begin_inset Formula $\left|V_{in}\right|<V_{f}$
\end_inset

 .
 During this crossing, the output will briefly exit saturation and be pulled
 up.
 On every quarter-cycle of the input (every half-cycle of the output), the
 off time is expected to be
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{off}=\frac{1}{2\pi\cdot60\textrm{Hz}}\sin^{-1}\left(\frac{1.1\textrm{V}}{120\sqrt{2}}\right)=17.2\mu s
\]

\end_inset


\end_layout

\begin_layout Standard
This indicates a pulse width of about 34.4us on every cycle of the output,
 assuming ideal operation of the opto.
 In practice, the pulse is wider.
 To maintain a consistent logic level, the pulse peak cannot exceed the
 input-high level for the port, 
\begin_inset Formula $V_{IH}=2\textrm{V}$
\end_inset

 (
\begin_inset CommandInset citation
LatexCommand cite
key "pic"
literal "false"

\end_inset

, p.
 55).
 Raising the capacitance across the output lowers the peak.
 The capacitor should be chosen to be high enough such that the input never
 exceeds 2V minus a safe margin, but low enough that the output still responds
 quickly when the voltage from the mains input is interrupted.
 When C3 is set to 100nF, the PIC WPU is enabled and the switch is energized,
 the zero-crossing peak reaches ~500mV (
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:scope-on-light"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 Due to the rectification action of the antiparallel optoisolator input,
 the waveform period is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
T=\frac{1}{2\cdot60\textrm{Hz}}=8.33\textrm{ms}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename opto peak.png
	width 75line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Oscilloscope on LIGHT line (optoisolator output) while switch is energized
\begin_inset CommandInset label
LatexCommand label
name "fig:scope-on-light"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename opto off.png
	width 75line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Oscilloscope on LIGHT line (optoisolator output) when switch is opened
\begin_inset CommandInset label
LatexCommand label
name "fig:scope-light-off"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset

When the switch is opened, C3 is allowed to fully discharge, and the output
 crosses 
\begin_inset Formula $V_{IH}$
\end_inset

 after 1.4ms, well below one cycle period (
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:scope-light-off"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 This is below the theoretical time, which can be explained by:
\end_layout

\begin_layout Itemize
tolerance in the WPU (15kâ34k, or -32% to +55%);
\end_layout

\begin_layout Itemize
the fact that
\begin_inset Formula $V_{DD}$
\end_inset

 is smaller than the 5.5V quoted in the WPU spec, and T < 25Â°C;
\end_layout

\begin_layout Itemize
tolerance in C3 (Â±10%);
\end_layout

\begin_layout Itemize
the opto not initially being fully off; and
\end_layout

\begin_layout Itemize
even when the opto is off, leakage (
\begin_inset Quotes eld
\end_inset

dark
\begin_inset Quotes erd
\end_inset

) opto collector current, which is rated at 
\begin_inset Formula $I_{CEO}\approx1\textrm{nA for }V_{CE}=10\textrm{V}$
\end_inset

 
\begin_inset CommandInset citation
LatexCommand cite
key "opto"
literal "false"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\textrm{For }V_{DD}=4.5\textrm{V},\,R_{WPUmax}\approx\frac{34-187}{5.5-2}\left(4.5-2\right)+187=77.7\textrm{k}\Omega
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{max}=-77.7\textrm{k}\Omega\cdot330\textrm{nF}\cdot1.1\ln\left(1-\frac{2}{4.5}\right)=16.6\textrm{ms}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{min}=-15\textrm{k}\Omega\cdot330\textrm{nF}\cdot0.9\ln\left(1-\frac{2}{5.5}\right)=2.0\textrm{ms (before accounting for opto leaks)}
\]

\end_inset


\end_layout

\begin_layout Subsection
Timing
\end_layout

\begin_layout Subsubsection
Controller
\end_layout

\begin_layout Standard
For a short delay, a simpler RC discharge circuit would be preferable; but
 for delays on the order of an hour, this is not feasible because of the
 large capacitance necessary and the risk of leakage error.
\end_layout

\begin_layout Standard
An appealing mixed analogue/digital alternative is the CD4060 timer family,
 originally of Harris Semiconductor, now Texas Instruments since 1998 
\begin_inset CommandInset citation
LatexCommand cite
key "ti-eats-harris"
literal "false"

\end_inset

.
 It has a built-in oscillator supporting either RC or crystal mode, a built-in
 divider, and support for high supply voltages of up to 20V.
 However, using it in this application would require surrounding digital
 latch circuitry, so a small microcontroller is more suitable.
\end_layout

\begin_layout Standard
This circuit needs a microcontroller meeting the criteria described in 
\begin_inset CommandInset ref
LatexCommand nameref
reference "subsec:vendor"
plural "false"
caps "false"
noprefix "false"

\end_inset

, plus:
\end_layout

\begin_layout Itemize
at least one analog-to-digital converter (ADC)
\end_layout

\begin_layout Itemize
support for a 5V supply
\end_layout

\begin_layout Itemize
support for enough I/O pins connecting the light detection input, fan output,
 and time trimmer
\end_layout

\begin_layout Standard
A good candidate is the PIC10F220 programmable interrupt controller from
 Microchip Technology.
 It is an inexpensive and very simple microcontroller with the following
 characteristics 
\begin_inset CommandInset citation
LatexCommand cite
key "pic"
literal "false"

\end_inset

:
\end_layout

\begin_layout Itemize
No interrupts, memory banking, or reassignable I/O (peripheral pin select,
 or PPS, available on higher-grade PICs)
\end_layout

\begin_layout Itemize
Four I/O pins
\end_layout

\begin_layout Itemize
A 4 or 8 MHz internal RC oscillator with internal calibration
\end_layout

\begin_layout Itemize
256 words of program memory, each 12 bits wide
\end_layout

\begin_layout Itemize
33 instructions
\end_layout

\begin_layout Itemize
16 bytes of static random access memory (SRAM)
\end_layout

\begin_layout Itemize
An 8-bit ADC
\end_layout

\begin_layout Standard
Utilization of the PIC's electronically erasible programming read-only memory
 (EEPROM) by the program is low and leaves room for expansion.
 According to the map file generated on build,
\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

                              Program Memory Usage 
\end_layout

\begin_layout Plain Layout

                               Start         End      
\end_layout

\begin_layout Plain Layout

                           ---------   ---------      
\end_layout

\begin_layout Plain Layout

                            0x000000    0x00002e      
\end_layout

\begin_layout Plain Layout

                            0x000fff    0x000fff      
\end_layout

\begin_layout Plain Layout

            48 out of 261 program addresses used, program memory utilization
 is 18%
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The PIC has been programmed in assembly (see 
\begin_inset CommandInset ref
LatexCommand nameref
reference "sec:code-listing-asm"
plural "false"
caps "false"
noprefix "false"

\end_inset

).
 Briefly, it:
\end_layout

\begin_layout Enumerate
Configures the oscillator based on factory calibration
\end_layout

\begin_layout Enumerate
Configures the OPTION, ADC, and tristate registers, including configuration
 to enable WPU for the optoisolator collector
\end_layout

\begin_layout Enumerate
Sleeps until it sees a 'low' on the light pin, indicating that the light
 switch has been energized
\end_layout

\begin_layout Enumerate
Spins until it sees a 'high' on the light pin, indicating that the light
 switch has been opened
\end_layout

\begin_layout Enumerate
Turns the fan on
\end_layout

\begin_layout Enumerate
Runs timer 0 for a period of time controlled by the position of the wiper
 arm in the time potentiometer, read by the ADC
\end_layout

\begin_layout Enumerate
Turns the fan off and goes back to sleep.
\end_layout

\begin_layout Subsubsection
Timer Scaling
\end_layout

\begin_layout Standard
Timer 0 is clocked by the internal oscillator divided by four.
 It is configured for the slowest prescaler available (1:256), and is eight
 bits wide.
 Thus, in hardware only, the maximum overflow time would be:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{o}=\frac{2^{8}\cdot256\cdot4}{4\textrm{MHz}}=65.5\textrm{ms}
\]

\end_inset


\end_layout

\begin_layout Standard
This is insufficient for the current application, which should support times
 up to an hour.
 The minimum number of software postscaler bits required is found by
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left\lceil \log_{2}\left(\frac{60^{2}\cdot4\textrm{MHz}}{256\cdot2^{8}\cdot4}\right)\right\rceil =\left\lceil 15.7\right\rceil =16
\]

\end_inset


\end_layout

\begin_layout Standard
Thus, two bytes of SRAM in nested decrement loops after overflow of TMR0
 will yield a duration above one hour:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{o}=\frac{2^{8}\cdot2^{16}\cdot256\cdot4}{4\textrm{MHz}}=4295\textrm{s (1:11:35)}
\]

\end_inset


\end_layout

\begin_layout Subsubsection
Timer Adjustment
\end_layout

\begin_layout Standard
The timer is adjustable via potentiometer R3 connected to the ADC.
 The effective impedance of the potentiometer circuit must be less than
 10k (
\begin_inset CommandInset citation
LatexCommand cite
key "pic"
literal "false"

\end_inset

, p.
 32).
 A suitable potentiometer is 4.7k, from the TE Connectivity CB10 Series 
\begin_inset CommandInset citation
LatexCommand cite
key "pot"
literal "false"

\end_inset

.
 It is screwdriver-adjustable and has an arrow indicator.
 The worst-case (highest) resistance is when the wiper arm is in the middle:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
R_{max}=\frac{4.7\textrm{k}\Omega}{2}||\frac{4.7\textrm{k}\Omega}{2}=1175\Omega
\]

\end_inset


\end_layout

\begin_layout Standard
By the ADC specification, the minimum acquisition time (neglecting thermal
 effects) is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{acq}=2\mu s+25\textrm{pF}(1\textrm{k}\Omega+7\textrm{k}\Omega+1175\Omega)\cdot9\ln2=3.4\mu s
\]

\end_inset


\end_layout

\begin_layout Standard
Due to the way that the firmware is written, the ADC is left on for many
 orders of magnitude above this acquisition time prior to initiating a conversio
n, so it is not a limiting factor.
\end_layout

\begin_layout Standard
The ADC input pin needs to be protected against noise.
 An RC lowpass filter is formed by
\end_layout

\begin_layout Itemize
ADC sample-and-hold capacitance 
\begin_inset Formula $C_{hold}=25$
\end_inset

pF (negligible)
\end_layout

\begin_layout Itemize
Input pin capacitance 
\begin_inset Formula $C_{pin}=5$
\end_inset

pF (negligible)
\end_layout

\begin_layout Itemize
Input pin leakage 
\begin_inset Formula $R_{leak}>10\textrm{M}\Omega$
\end_inset

 (negligible)
\end_layout

\begin_layout Itemize
ADC sample switch resistance 
\begin_inset Formula $R_{SS}=7\textrm{k}\Omega$
\end_inset


\end_layout

\begin_layout Itemize
Interconnect resistance 
\begin_inset Formula $R_{IC}\leq1\textrm{k}\Omega$
\end_inset


\end_layout

\begin_layout Itemize
Exterior potentiometer effective resistance 
\begin_inset Formula $R_{3eff}\leq1175\Omega$
\end_inset


\end_layout

\begin_layout Itemize
Exterior ADC filter capacitance 
\begin_inset Formula $C_{5}$
\end_inset


\end_layout

\begin_layout Standard
Critically, the cutoff frequency of this filter must be below the mains
 line frequency of 60Hz.
 Using a convenient ceramic capacitor of 1uF for C5 yields
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
f_{cmin}=\frac{1}{2\pi\cdot1\mu\textrm{F}\left(7\textrm{k}\Omega+1\textrm{k}\Omega+1175\Omega\right)}=17.3\textrm{Hz}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
f_{cmax}=\frac{1}{2\pi\cdot1\mu\textrm{F}\cdot7\textrm{k}\Omega}=22.7\textrm{Hz}
\]

\end_inset


\end_layout

\begin_layout Subsection
Fan Output
\begin_inset CommandInset label
LatexCommand label
name "subsec:fan-output"

\end_inset


\end_layout

\begin_layout Standard
The fan is energized by the following sequence of events.
 The PIC uses the tristate (TRIS) bit corresponding to general purpose I/O
 port 2 (GP2) to control whether the pin is in input or output mode.
 In the brief time during initialization where TRIS is not yet low and the
 port is in high-impedance mode, R4 acts as a weak pulldown and disables
 the fan by default.
 Once initialization is complete, TRIS for GP2 is kept low and the port
 is kept in the output state.
\end_layout

\begin_layout Standard
When the PIC timing logic needs to activate the fan, it sets GP2 high (5V).
 This activates Q1.
 Q1 is a general-purpose MOSFET from Supertex Inc.
 (Microchip Technology since 2014 
\begin_inset CommandInset citation
LatexCommand cite
key "microchip-eats-supertex"
literal "false"

\end_inset

).
 It is configured in common-source and used to drive the relay coil.
 Due to inductive effects and current higher than that tolerable by the
 PIC output port (71mA), the coil should not be driven by the PIC directly,
 but Q1 can tolerate up to 200mA 
\begin_inset CommandInset citation
LatexCommand cite
key "fet"
literal "false"

\end_inset

.
\end_layout

\begin_layout Standard
Q1 turns on, pulling down its drain and activating the relay coil.
 The relay closes, and current runs between AC/L and LIVE_FAN.
\end_layout

\begin_layout Standard
When the PIC timing logic needs to deactivate the fan, it sets GP2 low,
 which turns off Q1, opening its drain.
 The coil voltage will spike when the relay opens, but will be limited by
 the Schottky diode D1 entering forward bias.
 Since the fan motor is expected to be an inductive load, it may similarly
 spike, but will be limited by the MOV R5.
 A MOV is used due to the absence of absorption resistors and the failure
 mode characteristics of a TVS.
 MOVs have a negative temperature coefficient (NTC), meaning that as they
 heat up in an over-voltage event, their resistance decreases, increasing
 current on the circuit and allowing the circuit breaker to trip or fuse
 to blow; a TVS would fail before the circuit breaker or fuse could act.
\end_layout

\begin_layout Section
Simulation
\end_layout

\begin_layout Subsection
MPLAB
\end_layout

\begin_layout Standard
MPLAB has simulation facilities useful for predicting the behaviour of a
 PIC.
 Timed events on inputs can be constructed using stimuli, for example those
 of 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:stimulus"
plural "false"
caps "false"
noprefix "false"

\end_inset

, where AN0 (the trimmer) is set to 20mV; and the fan is set to turn on
 at 30us and off at 60us.
 In this scenario, we expect that the PIC will go to sleep soon after initializa
tion; wake up at 30us and turn on the fan; start the counter at 60us; and
 turn it off after the timer expires.
 The upper postscaler from ADRES should be
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename stimulus.png
	width 80line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Stimulus example in MPLABX simulator.
\begin_inset CommandInset label
LatexCommand label
name "fig:stimulus"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
\left\lfloor \frac{2^{8}\cdot20\textrm{mV}}{5\textrm{V}}\right\rfloor =1
\]

\end_inset


\end_layout

\begin_layout Standard
So the total timer should run for
\end_layout

\begin_layout Standard
\begin_inset Formula 
\[
t_{o}=\frac{2^{24}\cdot4}{4\textrm{MHz}}=16.777216\textrm{s}
\]

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:pic-sim-begin"
plural "false"
caps "true"
noprefix "false"

\end_inset

 shows that, for these stimuli, the processing latency between the 'light
 on' and 'fan on' events is 16us.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename pic-init.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
PIC in simulation, showing fan turning on and then off.
\begin_inset CommandInset label
LatexCommand label
name "fig:pic-sim-begin"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:pic-sim-regs"
plural "false"
caps "true"
noprefix "false"

\end_inset

 shows that, after the ADC has been run, the ADRES and upper-post values
 are as expected.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename pic-sim-regs.png

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
PIC in simulation, showing file registers after ADC conversion.
\begin_inset CommandInset label
LatexCommand label
name "fig:pic-sim-regs"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:pic-sim-off"
plural "false"
caps "true"
noprefix "false"

\end_inset

 shows that the fan is turned off exactly when predicted.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename pic-sim-stop.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
PIC in simulation, showing time at which timer expires and fan is turned
 off.
\begin_inset CommandInset label
LatexCommand label
name "fig:pic-sim-off"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
QUCS
\end_layout

\begin_layout Standard
The Quite Universal Circuit Simulator is used here to confirm some behaviours
 of the circuit leading up to the optoisolator.
 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:qucs-sch"
plural "false"
caps "true"
noprefix "false"

\end_inset

 shows the schematic for this simulation.
 Notable features include:
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename qucs-sch.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
QUCS simulation for optoisolator protection circuit.
\begin_inset CommandInset label
LatexCommand label
name "fig:qucs-sch"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Itemize
The input phase is set to 90Â° so that the mains voltage starts at cycle
 peak, modelling a worst-case surge.
\end_layout

\begin_layout Itemize
The TVS is modelled as serial opposing zeners, which is fairly close to
 how a bidirectional TVS is constructed.
\end_layout

\begin_layout Itemize
Similarly, the antiparallel LEDs of the optoisolator input are modelled
 by two diodes.
\end_layout

\begin_layout Standard
Figures 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:trans-v"
plural "false"
caps "false"
noprefix "false"

\end_inset

, 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:trans-i"
plural "false"
caps "false"
noprefix "false"

\end_inset

 and 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:trans-p"
plural "false"
caps "false"
noprefix "false"

\end_inset

 show the results of transient simulation over one input cycle, demonstrating
 surge behaviour and results close to those predicted by the analyses in
 
\begin_inset CommandInset ref
LatexCommand formatted
reference "subsec:opto-input"
plural "false"
caps "false"
noprefix "false"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename trans-v.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Transient simulation of pre-optocoupler network, voltages.
\begin_inset CommandInset label
LatexCommand label
name "fig:trans-v"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename trans-i.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Transient simulation of pre-optocoupler network, current.
\begin_inset CommandInset label
LatexCommand label
name "fig:trans-i"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename trans-p.png
	width 100line%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Transient simulation of pre-optocoupler network, resistor power.
\begin_inset CommandInset label
LatexCommand label
name "fig:trans-p"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
Board
\end_layout

\begin_layout Standard
The perfboard, being manually soldered, does not have traces or vias.
 However, care must still be taken in placement, to reduce the length of
 wiring needed, and to physically separate high-voltage regions from low-voltage
 regions.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename board.png
	height 80pheight%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Perfboard with airwires.
\begin_inset CommandInset label
LatexCommand label
name "fig:board"

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Layers shown in 
\begin_inset CommandInset ref
LatexCommand formatted
reference "fig:board"
plural "false"
caps "false"
noprefix "false"

\end_inset

 are:
\end_layout

\begin_layout Itemize
Unrouted (
\begin_inset Quotes eld
\end_inset

ratsnest/airwires
\begin_inset Quotes erd
\end_inset

) - The yellow lines between pins indicate wire that needs to be run.
\end_layout

\begin_layout Itemize
Dimension - the golden rectangle shows the edge of the board.
\end_layout

\begin_layout Itemize
tPlace and tDocu (grey) - component shapes.
 Some of these are approximations due to exact libraries being unavailable.
\end_layout

\begin_layout Itemize
tNames (grey) - component names.
\end_layout

\begin_layout Itemize
tValues (grey) - component values.
\end_layout

\begin_layout Itemize
tKeepout (red stipple) - these regions indicate where there are no holes
 in the perfboard; component pins cannot be placed here.
\end_layout

\begin_layout Itemize
vRestrict (green dash) - this illustrates the division between high voltage
 (left) isolated from low voltage (right).
\end_layout

\begin_layout Itemize
Drills (grey) - illustrates where holes for component pins must be.
 Pads are not shown.
\end_layout

\begin_layout Itemize
Holes (grey) - the holes in each corner of the board for mounting.
\end_layout

\begin_layout Itemize
Measures (grey) - the dimensions shown around the sides of the board.
 The board is 58x78mm edge to edge, but the usable pin area is 2100x2500mil.
 This is in mil because of the 100mil perforation pitch.
\end_layout

\begin_layout Section
Conclusion
\end_layout

\begin_layout Standard
This has been a good opportunity to stay up-to-date on domain knowledge
 and skills, and to research some areas of the field that are not covered
 in detail in school.
 The design concept is sound, and the device is functional after having
 been implemented.
 Future work could include:
\end_layout

\begin_layout Itemize
Replacing the enclosed power supply with a custom, discrete-component-based
 power supply to reduce cost
\end_layout

\begin_layout Itemize
Implementing a custom enclosure, potentially using 3D CAD and 3D printing
 technology
\end_layout

\begin_layout Itemize
Scaling the design up to be able to accommodate 240Vac or multi-phase input
\end_layout

\begin_layout Itemize
Scaling the design down physically, to use surface-mounted devices (SMD)
 reducing cost and space requirements
\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "cpd"
literal "false"

\end_inset

OACETT.
 (2013).
 Continuing Professional Development.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.oacett.org/Careers/CPD"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "comply"
literal "false"

\end_inset

OACETT.
 (2013).
 Suggested CPD Activities And Samples.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.oacett.org/Careers/CPD/Suggested_CPD_Activities_And_Samples"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "dk-shipping"
literal "false"

\end_inset

Digi-Key Electronics.
 (2018).
 Digi-Key Same Day Shipping.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.digikey.ca/en/help/same-day-shipping"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "ad-eats-eagle"
literal "false"

\end_inset

Berggen, Matt.
 (2016).
 Autodesk acquires EAGLE: Q&A and a look into future.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.autodesk.com/products/eagle/blog/autodesk-acquires-eagle-qa-look-future"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "psu"
literal "false"

\end_inset

MeanWell.
 (2018).
 IRM-01 Series, Document IRM-01-SPEC.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.meanwell.com/Upload/PDF/IRM-01/IRM-01-SPEC.PDF"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "tvs"
literal "false"

\end_inset

Littelfuse.
 (2017).
 Transient Voltage Suppression Diodes, P6KE Series.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.littelfuse.com/~/media/electronics/datasheets/tvs_diodes/littelfuse_tvs_diode_p6ke_datasheet.pdf.pdf"

\end_inset

 [sic]
\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "term"
literal "false"

\end_inset

WÃ¼rth Elektronik eiSos GmbH & Co.
 KG.
 (2017).
 Serie 1377 â 5.00mm Horizontal Entry w.
 Pressure Clamp.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://katalog.we-online.de/em/datasheet/691137710004.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "relay"
literal "false"

\end_inset

TE Connectivity.
 (2012).
 ORWH-1T Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.te.com/commerce/DocumentDelivery/DDEController?Action=srchrtrv&DocNm=1721150&DocType=Customer+Drawing&DocLang=English"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "stackpole-cfres"
literal "false"

\end_inset

StackPole Electronics Inc.
 (2018).
 CF/CFM Series Carbon Film Resistors.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.seielect.com/Catalog/SEI-CF_CFM.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "fuses"
literal "false"

\end_inset

Bel Power Solutions & Protection.
 (2016).
 Type 5MF/5MFP Fast Blow Fuse Series.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://belfuse.com/resources/datasheets/circuitprotection/ds-cp-5mf-5mfp-series.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "cptc"
literal "false"

\end_inset

Bourns, Inc.
 (2018).
 CMF-RL Series - Telecom CPTC Resettable Fuses, C1753 05/17/18.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.bourns.com/docs/Product-Datasheets/cmfrl.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "illinois-cap"
literal "false"

\end_inset

Illinois Capacitor.
 (2017).
 MMR Metallized Polyester Film Capacitors.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.illinoiscapacitor.com/pdf/seriesDocuments/MMR%20series.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "ti-eats-harris"
literal "false"

\end_inset

Lineback, J.
 Robert.
 (1998, November).
 TI buying Harris' logic portfolio.
 
\shape italic
Semiconductor Business News
\shape default
.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://web.archive.org/web/20000523164052/http://www.semibiznews.com/stories98/nov98x/8k05ti.htm"
literal "false"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "pic"
literal "false"

\end_inset

Microchip Technology Inc.
 (2013).
 PIC10F220/222 Data Sheet, Document DS40001270F.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.microchip.com/mymicrochip/filehandler.aspx?ddocname=en566609"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "opto"
literal "false"

\end_inset

Lite-On Technology Corporation.
 Part No LTV-814H/824H/844H (M, S, S-TA1), BNS-OD-C131/A4.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://media.digikey.com/pdf/Data%20Sheets/Lite-On%20PDFs/LTV-814H_824H_844H%20(M,S,S_TA1).pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "cd4060"
literal "false"

\end_inset

Texas Instruments Incorporated.
 (2003).
 CD4060B Types, Document SCHS049C.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.ti.com/lit/ds/symlink/cd4060b.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "pot"
literal "false"

\end_inset

TE Connectivity.
 (2014).
 Carbon Economy Trimmers, Type CB10 Series, Document 1773190 CIS BI 06/2014.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.te.com/commerce/DocumentDelivery/DDEController?Action=srchrtrv&DocNm=1773190&DocType=DS&DocLang=English"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "microchip-eats-supertex"
literal "false"

\end_inset

Microchip Technology Inc.
 (2014).
 Microchip Technology Announces Acquisition of Supertex, Inc.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.microchip.com/investor/Pressrelease/MCHP%20Announces%20Acquisition%20of%20Supertex,%20Inc.021014.pdf"

\end_inset


\end_layout

\begin_layout Bibliography
\noindent
\begin_inset CommandInset bibitem
LatexCommand bibitem
key "fet"
literal "false"

\end_inset

Supertex Inc.
 (2013).
 2N7000, Document DSFP-2N7000.
 Retrieved from
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "http://www.microchip.com/mymicrochip/filehandler.aspx?ddocname=en571380"

\end_inset


\end_layout

\begin_layout Part*
\start_of_appendix
Appendix
\end_layout

\begin_layout Section
Bill of Materials
\begin_inset CommandInset label
LatexCommand label
name "sec:bom"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="21" columns="7">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="right" valignment="top">
<column alignment="left" valignment="top">
<column alignment="left" valignment="top">
<column alignment="center" valignment="top">
<column alignment="decimal" decimal_point="." valignment="top">
<column alignment="decimal" decimal_point="." valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Ref
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
DKey Part #
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Mfg Part #
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Description
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Qty
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
$/u
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
$
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
C1,C2
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1572-1218-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
334MMR250K
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CAP FILM 0.33UF 10% 250VDC RAD
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.57
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1.14
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
C3
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
478-2472-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
SR215C104KAA
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CAP CER 0.1UF 50V X7R RADIAL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.28
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.28
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
C4,C5
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
445-173583-1-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
FG28X7R1E105KRT06
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CAP CER 1UF 25V X7R RADIAL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.45
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.90
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
D1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1655-1514-1-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
SB140TA
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
DIODE SCHOTTKY 40V 1A DO41
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.35
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.35
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
D2
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
F5659CT-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
P6KE91CA
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
TVS DIODE 77.8V 125V DO204AC
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.64
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.64
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
F1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
507-1269-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
5MF 5-R
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
FUSE GLASS 5A 125VAC 5X20MM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.29
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.29
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
F2
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CMF-RL35-0-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CMF-RL35-0
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
PTC RESET FUSE 220V 75MA RADIAL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.98
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.98
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
IC1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
PIC10F220-I/P-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
PIC10F220-I/P
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
IC MCU 8BIT 384B FLASH 8DIP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.87
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.87
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
K1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
PB2032-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
ORWH-SH-105D1F,000
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
RELAY GEN PURPOSE SPDT 10A 5V
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1.75
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1.75
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
OK1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
160-1350-5-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
LTV-814H
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
OPTOISOLATR 5KV TRANSISTOR 4-DIP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.70
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.70
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
Q1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2N7000-G-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2N7000-G
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
MOSFET N-CH 60V 0.2A TO92-3
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.53
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.53
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
R1,R2
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CF14JT1K60CT-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CF14JT1K60
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
RES 1.6K OHM 1/4W 5% AXIAL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.06
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.12
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
R3
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
A105656-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CB10LV472M
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
TRIMMER 4.7KOHM 0.15W PC PIN TOP
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.60
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.60
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
R4
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CF14JT100KCT-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
CF14JT100K
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
RES 100K OHM 1/4W 5% AXIAL
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.06
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.06
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
R5
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
MOV-07D201K-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
MOV-07D201K
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
VARISTOR 200V 1.2KA DISC 7MM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.51
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.51
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
U1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1866-2998-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
IRM-01-5
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
AC/DC CONVERTER 5V 1W
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
8.05
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
8.05
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
X1
\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
732-10957-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
691137710004
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
TERM BLOCK 4POS SIDE ENTRY 5MM
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1.01
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1.01
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1738-1000-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
FIT0099
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
BREADBOARD GENERAL PURPOSE PTH
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
1
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2.17
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2.17
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="right" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
507-1703-ND
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
FC-203-22
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
FUSE CLIP CARTRIDGE PCB
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
2
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.07
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\size footnotesize
0.14
\end_layout

\end_inset
</cell>
</row>
<row>
<cell multicolumn="1" alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\series bold
Total
\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="right" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell multicolumn="2" alignment="left" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
23
\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\end_layout

\end_inset
</cell>
<cell alignment="decimal" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
21.09
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Section
Code Listing: PIC10F220 Assembly
\begin_inset CommandInset label
LatexCommand label
name "sec:code-listing-asm"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

#include <mpasmx.inc>
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    list
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

GP_LIGHT equ GP1
\end_layout

\begin_layout Plain Layout

GP_FAN   equ GP2
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

; The PIC10F220 is a simple device that has:
\end_layout

\begin_layout Plain Layout

    ; 4/8MHz internal RC osc
\end_layout

\begin_layout Plain Layout

    ; 256 words program mem
\end_layout

\begin_layout Plain Layout

    ; 16 bytes SRAM
\end_layout

\begin_layout Plain Layout

    ; No banks, interrupts or PPS
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

; Config:
\end_layout

\begin_layout Plain Layout

    ; 4MHZ internal RC osc
\end_layout

\begin_layout Plain Layout

    ; pullup enabled on GP3 (has no effect due to MCLRE)
\end_layout

\begin_layout Plain Layout

    ; watchdog timer disabled
\end_layout

\begin_layout Plain Layout

    ; code protection off
\end_layout

\begin_layout Plain Layout

    ; GPIO on MCLR pin so that reset line is tied to Vdd
\end_layout

\begin_layout Plain Layout

    __config _IOSCFS_4MHZ & _MCPU_ON & _WDTE_OFF & _CP_OFF & _MCLRE_OFF
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    udata
\end_layout

\begin_layout Plain Layout

post res 2 ; 16-bit software postscaler
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

res_vect code 0
\end_layout

\begin_layout Plain Layout

    ; Setup --------------------------------------------------------------------
\end_layout

\begin_layout Plain Layout

    ; We get here on powerup, any kind of reset, or wakeup-from-sleep.
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; First: PC starts at the end of memory, containing MOVLW <factory osccal>
\end_layout

\begin_layout Plain Layout

    ; but only if it's a power-on-reset
\end_layout

\begin_layout Plain Layout

    btfsc STATUS, GPWUF  ; wakeup must be clear (no wakeup)
\end_layout

\begin_layout Plain Layout

    goto cal_done
\end_layout

\begin_layout Plain Layout

    btfss STATUS, NOT_TO ; !TO must be high (no WDT timeout)
\end_layout

\begin_layout Plain Layout

    goto cal_done
\end_layout

\begin_layout Plain Layout

    btfss STATUS, NOT_PD ; !PD must be high (no sleep)
\end_layout

\begin_layout Plain Layout

    goto cal_done
\end_layout

\begin_layout Plain Layout

    movwf OSCCAL         ; If these are all true, it was a POR; move W into
 OSCCAL
\end_layout

\begin_layout Plain Layout

    bcf OSCCAL, FOSC4    ; Disable osc output; enable digital I/O on GP2
\end_layout

\begin_layout Plain Layout

cal_done:
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; GP0: analog in - time adj (ANS0=1)
\end_layout

\begin_layout Plain Layout

    ; GP1: digital in, WPU - !light (ANS1=0)
\end_layout

\begin_layout Plain Layout

    ; GP2: digital out - fan (FOSC4=0, T0CS=0)
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; !GPWU=0: enable wakeup on pin change 
\end_layout

\begin_layout Plain Layout

    ; !GPPU=0: enable weak pullup on GP0,1,3
\end_layout

\begin_layout Plain Layout

    ; T0CS=0: timer 0 internally clocked
\end_layout

\begin_layout Plain Layout

    ; T0SE=0: ignored
\end_layout

\begin_layout Plain Layout

    ; PSA=0: prescaler assigned to timer 0
\end_layout

\begin_layout Plain Layout

    ; PS=111: 1:256 prescaler
\end_layout

\begin_layout Plain Layout

    movlw b'111'
\end_layout

\begin_layout Plain Layout

    option
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; ANS1=0: GP1 digital
\end_layout

\begin_layout Plain Layout

    ; ANS0=1: GP0 analog in
\end_layout

\begin_layout Plain Layout

    ; CHS=00: channel GP0/AN0
\end_layout

\begin_layout Plain Layout

    ; GO=0: not converting yet
\end_layout

\begin_layout Plain Layout

    ; ADON=1: ADC is enabled
\end_layout

\begin_layout Plain Layout

    movlw b'01000001'
\end_layout

\begin_layout Plain Layout

    movwf ADCON0
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; We can write to the fan port latch even if it's still in input mode;
\end_layout

\begin_layout Plain Layout

    ; this ensures no glitch between clearing TRIS and sending the fan output.
\end_layout

\begin_layout Plain Layout

    ; (but this doesn't work in the simulator)
\end_layout

\begin_layout Plain Layout

    btfsc GPIO, GP_LIGHT  ; Check light status (negative logic)
\end_layout

\begin_layout Plain Layout

    goto light_off
\end_layout

\begin_layout Plain Layout

light_on:            ; if it's clear, the light's on
\end_layout

\begin_layout Plain Layout

    bsf GPIO, GP_FAN ; turn fan on
\end_layout

\begin_layout Plain Layout

    goto fan_done
\end_layout

\begin_layout Plain Layout

light_off:           ; if it's set, the light's off
\end_layout

\begin_layout Plain Layout

    bcf GPIO, GP_FAN ; turn fan off (we'll go to sleep in a bit)
\end_layout

\begin_layout Plain Layout

fan_done:
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    movlw b'1011'    ; only GP2 output, others input
\end_layout

\begin_layout Plain Layout

    tris GPIO
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; Pin change logic ---------------------------------------------------------
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    ; If the light is off, go to sleep.
 When a pin changes, the MCU will reset
\end_layout

\begin_layout Plain Layout

    ; and TRIS will be temporarily reset to all inputs, but that's fine
 because
\end_layout

\begin_layout Plain Layout

    ; we have a pulldown and output should be low anyway.
 (The light is logic-
\end_layout

\begin_layout Plain Layout

    ; low.)
\end_layout

\begin_layout Plain Layout

    btfsc GPIO, GP_LIGHT ; If the light is on (negative logic), don't sleep
\end_layout

\begin_layout Plain Layout

    sleep                ; The light is off, so sleep
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

wait_fanoff:
\end_layout

\begin_layout Plain Layout

    bsf GPIO, GP_FAN     ; The light is on (GP1==0), so turn the fan on.
\end_layout

\begin_layout Plain Layout

    btfss GPIO, GP_LIGHT ; Until the light is off (negative logic)
\end_layout

\begin_layout Plain Layout

    goto $-1             ; spin.
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; Adjust -------------------------------------------------------------------
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; For the 4.7k pot, worst-case Rs is (4.7k/2)||(4.7k/2) = 1175
\end_layout

\begin_layout Plain Layout

    ; Tacq = Tamp + Tc + Tcoff
\end_layout

\begin_layout Plain Layout

    ;      = 2us + (25pF)(1k + 7k + 1175)*9ln2 + 0
\end_layout

\begin_layout Plain Layout

    ;      = 3.4us
\end_layout

\begin_layout Plain Layout

    ; Assume that, after all this time waiting for the light, that's been
\end_layout

\begin_layout Plain Layout

    ; reached a million times over.
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    bsf ADCON0, NOT_DONE   ; Start conversion
\end_layout

\begin_layout Plain Layout

    btfsc ADCON0, NOT_DONE ; Done waiting if conversion is done
\end_layout

\begin_layout Plain Layout

    goto $-1               ; Keep waiting
\end_layout

\begin_layout Plain Layout

    movf ADRES, W          ; Copy ADC result
\end_layout

\begin_layout Plain Layout

    movwf post+1           ; to upper postscale byte
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; Timer --------------------------------------------------------------------
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    clrf TMR0 ; The timer is already running; clear it
\end_layout

\begin_layout Plain Layout

    clrf post+0 ; Clear lower soft postscaler
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; 1:256 prescaler, 8 bit, uses 4MHz/4
\end_layout

\begin_layout Plain Layout

    ;     pre tm0 po1 po2 fosc/4
\end_layout

\begin_layout Plain Layout

    ; t = 256*256*256*x  *4/4MHz = 17s - 72m
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

tmr0_loop:
\end_layout

\begin_layout Plain Layout

    ; Wait until after we've passed 0
\end_layout

\begin_layout Plain Layout

    movf TMR0, W    ; Check TMR0
\end_layout

\begin_layout Plain Layout

    btfsc STATUS, Z ; If it's not 0, stop comparing
\end_layout

\begin_layout Plain Layout

    goto $-2        ; keep comparing
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; Wait for timer overflow
\end_layout

\begin_layout Plain Layout

    btfss GPIO, GP_LIGHT ; Check if the light turned on while we were waiting
\end_layout

\begin_layout Plain Layout

    goto wait_fanoff     ; If so, abort wait
\end_layout

\begin_layout Plain Layout

    movf TMR0, W         ; Check TMR0
\end_layout

\begin_layout Plain Layout

    btfss STATUS, Z      ; If it's zero, stop comparing
\end_layout

\begin_layout Plain Layout

    goto $-4             ; keep comparing
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    decfsz post, f   ; Decrement lower postscale
\end_layout

\begin_layout Plain Layout

    goto tmr0_loop   ; Wait some more if no overflow
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    decfsz post+1, f ; Decrement upper postscale (use ADRES)
\end_layout

\begin_layout Plain Layout

    goto tmr0_loop   ; Wait some more if not expired
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    ; Fan off ------------------------------------------------------------------
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    bcf GPIO, GP_FAN ; Turn the fan off
\end_layout

\begin_layout Plain Layout

    sleep            ; Sleep until light comes on again
\end_layout

\begin_layout Plain Layout

    
\end_layout

\begin_layout Plain Layout

    end
\end_layout

\end_inset


\end_layout

\begin_layout Section
Code Listing: elsel.py
\begin_inset CommandInset label
LatexCommand label
name "sec:code-listing-elsel"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset listings
inline false
status open

\begin_layout Plain Layout

#!/usr/bin/env python3
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

from bisect import bisect
\end_layout

\begin_layout Plain Layout

from itertools import count, islice
\end_layout

\begin_layout Plain Layout

from math import *
\end_layout

\begin_layout Plain Layout

import math
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# https://en.wikipedia.org/wiki/E_series_of_preferred_numbers
\end_layout

\begin_layout Plain Layout

e_series = {3: (1.0, 2.2, 4.7),
\end_layout

\begin_layout Plain Layout

            6: (1.0, 1.5, 2.2, 3.3, 4.7, 6.8),
\end_layout

\begin_layout Plain Layout

            12: (1.0, 1.2, 1.5, 1.8, 2.2, 2.7, 3.3, 3.9, 4.7, 5.6, 6.8, 8.2),
\end_layout

\begin_layout Plain Layout

            24: (1.0, 1.1, 1.2, 1.3, 1.5, 1.6, 1.8, 2.0, 2.2, 2.4, 2.7, 3.0,
\end_layout

\begin_layout Plain Layout

                 3.3, 3.6, 3.9, 4.3, 4.7, 5.1, 5.6, 6.2, 6.8, 7.5, 8.2, 9.1),
\end_layout

\begin_layout Plain Layout

            48: (1.00, 1.05, 1.10, 1.15, 1.21, 1.27, 1.33, 1.40, 1.47, 1.54,
\end_layout

\begin_layout Plain Layout

                 1.62, 1.69, 1.78, 1.87, 1.96, 2.05, 2.15, 2.26, 2.37, 2.49,
\end_layout

\begin_layout Plain Layout

                 2.61, 2.74, 2.87, 3.01, 3.16, 3.32, 3.48, 3.65, 3.83, 4.02,
\end_layout

\begin_layout Plain Layout

                 4.22, 4.42, 4.64, 4.87, 5.11, 5.36, 5.62, 5.90, 6.19, 6.49,
\end_layout

\begin_layout Plain Layout

                 6.81, 7.15, 7.50, 7.87, 8.25, 8.66, 9.09, 9.53),
\end_layout

\begin_layout Plain Layout

            96: (1.00, 1.02, 1.05, 1.07, 1.10, 1.13, 1.15, 1.18, 1.21, 1.24,
\end_layout

\begin_layout Plain Layout

                 1.27, 1.30, 1.33, 1.37, 1.40, 1.43, 1.47, 1.50, 1.54, 1.58,
\end_layout

\begin_layout Plain Layout

                 1.62, 1.65, 1.69, 1.74, 1.78, 1.82, 1.87, 1.91, 1.96, 2.00,
\end_layout

\begin_layout Plain Layout

                 2.05, 2.10, 2.15, 2.21, 2.26, 2.32, 2.37, 2.43, 2.49, 2.55,
\end_layout

\begin_layout Plain Layout

                 2.61, 2.67, 2.74, 2.80, 2.87, 2.94, 3.01, 3.09, 3.16, 3.24,
\end_layout

\begin_layout Plain Layout

                 3.32, 3.40, 3.48, 3.57, 3.65, 3.74, 3.83, 3.92, 4.02, 4.12,
\end_layout

\begin_layout Plain Layout

                 4.22, 4.32, 4.42, 4.53, 4.64, 4.75, 4.87, 4.99, 5.11, 5.23,
\end_layout

\begin_layout Plain Layout

                 5.36, 5.49, 5.62, 5.76, 5.90, 6.04, 6.19, 6.34, 6.49, 6.65,
\end_layout

\begin_layout Plain Layout

                 6.81, 6.98, 7.15, 7.32, 7.50, 7.68, 7.87, 8.06, 8.25, 8.45,
\end_layout

\begin_layout Plain Layout

                 8.66, 8.87, 9.09, 9.31, 9.53, 9.76),
\end_layout

\begin_layout Plain Layout

            192: (1.00, 1.01, 1.02, 1.04, 1.05, 1.06, 1.07, 1.09, 1.10, 1.11,
\end_layout

\begin_layout Plain Layout

                  1.13, 1.14, 1.15, 1.17, 1.18, 1.20, 1.21, 1.23, 1.24, 1.26,
\end_layout

\begin_layout Plain Layout

                  1.27, 1.29, 1.30, 1.32, 1.33, 1.35, 1.37, 1.38, 1.40, 1.42,
\end_layout

\begin_layout Plain Layout

                  1.43, 1.45, 1.47, 1.49, 1.50, 1.52, 1.54, 1.56, 1.58, 1.60,
\end_layout

\begin_layout Plain Layout

                  1.62, 1.64, 1.65, 1.67, 1.69, 1.72, 1.74, 1.76, 1.78, 1.80,
\end_layout

\begin_layout Plain Layout

                  1.82, 1.84, 1.87, 1.89, 1.91, 1.93, 1.96, 1.98, 2.00, 2.03,
\end_layout

\begin_layout Plain Layout

                  2.05, 2.08, 2.10, 2.13, 2.15, 2.18, 2.21, 2.23, 2.26, 2.29,
\end_layout

\begin_layout Plain Layout

                  2.32, 2.34, 2.37, 2.40, 2.43, 2.46, 2.49, 2.52, 2.55, 2.58,
\end_layout

\begin_layout Plain Layout

                  2.61, 2.64, 2.67, 2.71, 2.74, 2.77, 2.80, 2.84, 2.87, 2.91,
\end_layout

\begin_layout Plain Layout

                  2.94, 2.98, 3.01, 3.05, 3.09, 3.12, 3.16, 3.20, 3.24, 3.28,
\end_layout

\begin_layout Plain Layout

                  3.32, 3.36, 3.40, 3.44, 3.48, 3.52, 3.57, 3.61, 3.65, 3.70,
\end_layout

\begin_layout Plain Layout

                  3.74, 3.79, 3.83, 3.88, 3.92, 3.97, 4.02, 4.07, 4.12, 4.17,
\end_layout

\begin_layout Plain Layout

                  4.22, 4.27, 4.32, 4.37, 4.42, 4.48, 4.53, 4.59, 4.64, 4.70,
\end_layout

\begin_layout Plain Layout

                  4.75, 4.81, 4.87, 4.93, 4.99, 5.05, 5.11, 5.17, 5.23, 5.30,
\end_layout

\begin_layout Plain Layout

                  5.36, 5.42, 5.49, 5.56, 5.62, 5.69, 5.76, 5.83, 5.90, 5.97,
\end_layout

\begin_layout Plain Layout

                  6.04, 6.12, 6.19, 6.26, 6.34, 6.42, 6.49, 6.57, 6.65, 6.73,
\end_layout

\begin_layout Plain Layout

                  6.81, 6.90, 6.98, 7.06, 7.15, 7.23, 7.32, 7.41, 7.50, 7.59,
\end_layout

\begin_layout Plain Layout

                  7.68, 7.77, 7.87, 7.96, 8.06, 8.16, 8.25, 8.35, 8.45, 8.56,
\end_layout

\begin_layout Plain Layout

                  8.66, 8.76, 8.87, 8.98, 9.09, 9.20, 9.31, 9.42, 9.53, 9.65,
\end_layout

\begin_layout Plain Layout

                  9.76, 9.88)}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

class Var:
\end_layout

\begin_layout Plain Layout

    def __init__(self, name, vmin=None, vmax=None, precision=None, value=None,
\end_layout

\begin_layout Plain Layout

                 values=None):
\end_layout

\begin_layout Plain Layout

        self.name, self.precision = name, precision
\end_layout

\begin_layout Plain Layout

        if value is not None and not isinstance(value, str):
\end_layout

\begin_layout Plain Layout

            self.value = None
\end_layout

\begin_layout Plain Layout

            self.values = (value,)
\end_layout

\begin_layout Plain Layout

            self.vmin = (value,)
\end_layout

\begin_layout Plain Layout

            self.vmax = (value,)
\end_layout

\begin_layout Plain Layout

        elif values is not None:
\end_layout

\begin_layout Plain Layout

            self.value = None
\end_layout

\begin_layout Plain Layout

            self.values = values
\end_layout

\begin_layout Plain Layout

            self.vmin = (min(values),) if vmin is None else (vmin,)
\end_layout

\begin_layout Plain Layout

            self.vmax = (max(values),) if vmax is None else (vmax,)
\end_layout

\begin_layout Plain Layout

        else:
\end_layout

\begin_layout Plain Layout

            self.value = value
\end_layout

\begin_layout Plain Layout

            self.values = None
\end_layout

\begin_layout Plain Layout

            self.vmin, self.vmax = vmin, vmax
\end_layout

\begin_layout Plain Layout

        self.ideal_value = None
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    def iter_ser(self, x, delta=0):
\end_layout

\begin_layout Plain Layout

        man, pw = to_eser(x)
\end_layout

\begin_layout Plain Layout

        ser = e_series[self.precision]
\end_layout

\begin_layout Plain Layout

        start = bisect(ser, man) + delta
\end_layout

\begin_layout Plain Layout

        ser_arranged = ser[start:] + tuple(10*x for x in ser[:start])
\end_layout

\begin_layout Plain Layout

        for pw in count(pw):
\end_layout

\begin_layout Plain Layout

            fac = 10**pw
\end_layout

\begin_layout Plain Layout

            for man in ser_arranged:
\end_layout

\begin_layout Plain Layout

                yield fac*man
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    @property
\end_layout

\begin_layout Plain Layout

    def mins(self):
\end_layout

\begin_layout Plain Layout

        return [num_or_eval(l) for l in self.vmin]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    @property
\end_layout

\begin_layout Plain Layout

    def maxes(self):
\end_layout

\begin_layout Plain Layout

        return [num_or_eval(l) for l in self.vmax]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    def get_values(self):
\end_layout

\begin_layout Plain Layout

        if self.values is not None:
\end_layout

\begin_layout Plain Layout

            yield from self.values
\end_layout

\begin_layout Plain Layout

        elif isinstance(self.value, str):
\end_layout

\begin_layout Plain Layout

            x = eval_env(self.value)
\end_layout

\begin_layout Plain Layout

            if self.precision:
\end_layout

\begin_layout Plain Layout

                self.ideal_value = x
\end_layout

\begin_layout Plain Layout

                yield from islice(self.iter_ser(x, -1), 2)
\end_layout

\begin_layout Plain Layout

            else:
\end_layout

\begin_layout Plain Layout

                yield x
\end_layout

\begin_layout Plain Layout

        else:
\end_layout

\begin_layout Plain Layout

            vmin = max(self.mins)
\end_layout

\begin_layout Plain Layout

            vmax = min(self.maxes)
\end_layout

\begin_layout Plain Layout

            for x in self.iter_ser(vmin):
\end_layout

\begin_layout Plain Layout

                if x > vmax:
\end_layout

\begin_layout Plain Layout

                    return
\end_layout

\begin_layout Plain Layout

                yield x
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    def __str__(self):
\end_layout

\begin_layout Plain Layout

        return self.name
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def to_eser(x):
\end_layout

\begin_layout Plain Layout

    pw = floor(log10(x))
\end_layout

\begin_layout Plain Layout

    mant = x / 10**pw
\end_layout

\begin_layout Plain Layout

    return mant, pw
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

dims = (Var('w', value=2*pi*60),         # angular velocity, rad/s
\end_layout

\begin_layout Plain Layout

        Var('Vin', value=120*sqrt(2)),   # peak AC live line, V
\end_layout

\begin_layout Plain Layout

        Var('Prp', value=40),            # pulse power (1ms), W
\end_layout

\begin_layout Plain Layout

        Var('Pr', value=0.2),            # continuous res power, W
\end_layout

\begin_layout Plain Layout

        Var('Vf', value=1.1),            # Opto forward drop, V
\end_layout

\begin_layout Plain Layout

        Var('I', value=10e-3),           # peak current for opto, typ, A
\end_layout

\begin_layout Plain Layout

        Var('Imax', value=150e-3),       # max current for opto, A
\end_layout

\begin_layout Plain Layout

        Var('Vpasv', value='Vin - Vf'),  # potential over passives, V
\end_layout

\begin_layout Plain Layout

        Var('Rd', value='Vf/I'),         # equivalent diode res during Ityp,
 V
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        #Var('Vbr', values=(  6.40,   6.45,   6.67,   7.13,  7.22,  7.78,  7.79,
\end_layout

\begin_layout Plain Layout

        #                     8.65,   8.89,   9.50,  10.00, 10.50, 11.10, 11.40,
\end_layout

\begin_layout Plain Layout

        #                    12.20,  12.40,  14.30,  14.40, 15.20, 17.10, 17.80,
\end_layout

\begin_layout Plain Layout

        #                    19.00,  20.00,  20.90,  22.20, 22.80, 25.70, 28.50,
\end_layout

\begin_layout Plain Layout

        #                    31.40,  34.20,  37.10,  40.00, 40.90, 44.70, 48.50,
\end_layout

\begin_layout Plain Layout

        #                    53.20,  58.90,  64.60,  71.30, 77.90, 86.50, 95.00,
\end_layout

\begin_layout Plain Layout

        #                   105.00, 114.00, 124.00, 143.00)),
\end_layout

\begin_layout Plain Layout

        Var('Vbr', value=86.5),
\end_layout

\begin_layout Plain Layout

        Var('Zz', value='Vbr/I'),  # typ
\end_layout

\begin_layout Plain Layout

        Var('Vrc1', value='Vin - Vbr'),
\end_layout

\begin_layout Plain Layout

        Var('Vrc2', value='Vbr - Vf'),
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        # Vz peak is fixed at Vbr, but the proportion between R2 and C2
 can vary.
\end_layout

\begin_layout Plain Layout

        Var('R2', precision=24, vmin=('Vrc2/Imax',     # Limit opto discharged
 I
\end_layout

\begin_layout Plain Layout

                                      'Vrc2**2/Prp'),  # Limit res pulse
 P
\end_layout

\begin_layout Plain Layout

                                vmax=('Vrc2/I - 1',    # Turn on opto
\end_layout

\begin_layout Plain Layout

                                      'Prp/Imax**2',   # Limit res pulse
 P
\end_layout

\begin_layout Plain Layout

                                      'Pr/I**2')),     # Limit res continous
 P
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        Var('C2', precision=12, value='1/w/sqrt(Zz**2 - (R2 + Rd)**2)'),
\end_layout

\begin_layout Plain Layout

        Var('Xc2', value='1/w/C2'),
\end_layout

\begin_layout Plain Layout

        Var('ImVz', value='I*Xc2'),
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        Var('R1', precision=24, vmin=('Vrc1/Imax',     # Limit opto discharged
 I
\end_layout

\begin_layout Plain Layout

                                      'Vrc1**2/Prp'),  # Limit res pulse
 P
\end_layout

\begin_layout Plain Layout

                                vmax=('Vrc1/I - 1',    # Turn on opto
\end_layout

\begin_layout Plain Layout

                                      'Prp/Imax**2',   # Limit res pulse
 P
\end_layout

\begin_layout Plain Layout

                                      'Pr/I**2')),     # Limit res continous
 P
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        Var('C1', precision=12, value='I/w/(sqrt(Vin**2 - (Vf + I*R2)**2)
 - ImVz)'),
\end_layout

\begin_layout Plain Layout

        Var('Xc1', value='1/w/C1'))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

math_locals = {n: getattr(math, n) for n in dir(math) if not n.startswith('_')}
\end_layout

\begin_layout Plain Layout

sym_locals = {}
\end_layout

\begin_layout Plain Layout

dims_by_name = {d.name: d for d in dims}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def eval_env(ex):
\end_layout

\begin_layout Plain Layout

    locs = dict(math_locals)
\end_layout

\begin_layout Plain Layout

    locs.update(sym_locals)
\end_layout

\begin_layout Plain Layout

    return eval(ex, {}, locs)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def num_or_eval(n):
\end_layout

\begin_layout Plain Layout

    return n if isinstance(n, (int, float)) else eval_env(n)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def header():
\end_layout

\begin_layout Plain Layout

    print(
\end_layout

\begin_layout Plain Layout

        '
\backslash
n'
\end_layout

\begin_layout Plain Layout

        '{:>7} {:>7} {:>7} {:>7} {:>7} {:>7} {:>7} '
\end_layout

\begin_layout Plain Layout

        '{:>7} {:>7} {:>7} {:>7} {:>7} {:>7} {:>7}'.format(
\end_layout

\begin_layout Plain Layout

        'R1', 'C1', 'R2', 'C2', 'Vbr', 'Vz', 'IpkmA', 'IpspkmA',
\end_layout

\begin_layout Plain Layout

        'Pr1acmW', 'Pr1pkW', 'Pr2acmW', 'Pr2pkW', 'Vc1pk', 'Vc2pk'))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

actuals = []
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def populate_actual():
\end_layout

\begin_layout Plain Layout

    if (sym_locals['R1'] != sym_locals['R2'] or
\end_layout

\begin_layout Plain Layout

            sym_locals['C1'] != sym_locals['C2']):
\end_layout

\begin_layout Plain Layout

        return
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Rt = eval_env('Rd + R1 + R2')
\end_layout

\begin_layout Plain Layout

    Xt = eval_env('-Xc1 - Xc2')
\end_layout

\begin_layout Plain Layout

    Zt = sqrt(Rt**2 + Xt**2)
\end_layout

\begin_layout Plain Layout

    Zta = atan2(Xt, Rt)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Itm = sym_locals['Vin'] / Zt
\end_layout

\begin_layout Plain Layout

    Ita = -Zta
\end_layout

\begin_layout Plain Layout

    Itr = Itm * cos(Ita)
\end_layout

\begin_layout Plain Layout

    Iti = Itm * sin(Ita)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Rz2 = eval_env('Rd + R2')
\end_layout

\begin_layout Plain Layout

    Xz2 = -sym_locals['Xc2']
\end_layout

\begin_layout Plain Layout

    Z2m = sqrt(Rz2**2 + Xz2**2)
\end_layout

\begin_layout Plain Layout

    Z2a = atan2(Xz2, Rz2)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    V2m = Itm * Z2m
\end_layout

\begin_layout Plain Layout

    V2a = Ita + Z2a
\end_layout

\begin_layout Plain Layout

    V2r = V2m * cos(V2a)
\end_layout

\begin_layout Plain Layout

    V2i = V2m * sin(V2a)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    err = V2m/sym_locals['Vbr'] - 1
\end_layout

\begin_layout Plain Layout

    if not (-0.05 <= err <= 0):
\end_layout

\begin_layout Plain Layout

        return
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Rz1 = sym_locals['R1']
\end_layout

\begin_layout Plain Layout

    Xz1 = -sym_locals['Xc1']
\end_layout

\begin_layout Plain Layout

    Z1m = sqrt(Rz1**2 + Xz1**2)
\end_layout

\begin_layout Plain Layout

    Z1a = atan2(Xz1, Rz1)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    V1m = Itm * Z1m
\end_layout

\begin_layout Plain Layout

    V1a = Ita + Z1a
\end_layout

\begin_layout Plain Layout

    V1r = V1m * cos(V1a)
\end_layout

\begin_layout Plain Layout

    V1i = V1m * sin(V1a)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    assert (abs(V1i + V2i) < 1e-12)  # Vin is at 0 degrees
\end_layout

\begin_layout Plain Layout

    # Vin's components sum to Vin
\end_layout

\begin_layout Plain Layout

    assert (abs(V1r + V2r - sym_locals['Vin']) < 1e-12)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Ipulse = sym_locals['Vin'] / Rt
\end_layout

\begin_layout Plain Layout

    Ppr1 = Ipulse**2 * sym_locals['R1']
\end_layout

\begin_layout Plain Layout

    Ppr2 = Ipulse**2 * sym_locals['R2']
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    Irms = Itm / sqrt(2)
\end_layout

\begin_layout Plain Layout

    Pr1 = Irms**2 * sym_locals['R1']
\end_layout

\begin_layout Plain Layout

    Pr2 = Irms**2 * sym_locals['R2']
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

    state = dict(sym_locals)
\end_layout

\begin_layout Plain Layout

    state.update({'Vz': V2m,
\end_layout

\begin_layout Plain Layout

                  'Ityp': Itm*1e3,
\end_layout

\begin_layout Plain Layout

                  'Ichg': Ipulse*1e3,
\end_layout

\begin_layout Plain Layout

                  'Pr1': Pr1*1e3,
\end_layout

\begin_layout Plain Layout

                  'Ppr1': Ppr1,
\end_layout

\begin_layout Plain Layout

                  'Pr2': Pr2*1e3,
\end_layout

\begin_layout Plain Layout

                  'Ppr2': Ppr2,
\end_layout

\begin_layout Plain Layout

                  'Vc1': sym_locals['Xc1']*Itm,
\end_layout

\begin_layout Plain Layout

                  'Vc2': sym_locals['Xc2']*Itm})
\end_layout

\begin_layout Plain Layout

    actuals.append(state)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def dump():
\end_layout

\begin_layout Plain Layout

    tab_size = 40
\end_layout

\begin_layout Plain Layout

    for di in range(0, len(actuals), tab_size):
\end_layout

\begin_layout Plain Layout

        header()
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

        for d in actuals[di: di+tab_size]:
\end_layout

\begin_layout Plain Layout

            # 'R1', 'C1', 'R2', 'C2', 'Vbr', 'Vz', 'Ityp', 'Ichg', 'Pr1',
\end_layout

\begin_layout Plain Layout

            # 'Ppr1', 'Pr2', 'Ppr2', 'Vc1', 'Vc2'
\end_layout

\begin_layout Plain Layout

            print(
\end_layout

\begin_layout Plain Layout

               '{R1:>7.0f} {C1:>7.1e} {R2:>7.0f} {C2:>7.1e} '
\end_layout

\begin_layout Plain Layout

               '{Vbr:>7.1f} {Vz:>7.2f} {Ityp:>7.2f} {Ichg:>7.2f} '
\end_layout

\begin_layout Plain Layout

               '{Pr1:>7.1f} {Ppr1:>7.1f} {Pr2:>7.1f} {Ppr2:>7.1f} '
\end_layout

\begin_layout Plain Layout

               '{Vc1:>7.2f} {Vc2:>7.2f}'.format(**d))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

def recurse(dim_index=0):
\end_layout

\begin_layout Plain Layout

    dim = dims[dim_index]
\end_layout

\begin_layout Plain Layout

    for x in dim.get_values():
\end_layout

\begin_layout Plain Layout

        sym_locals[dim.name] = x
\end_layout

\begin_layout Plain Layout

        if dim_index < len(dims) - 1:
\end_layout

\begin_layout Plain Layout

            recurse(dim_index + 1)
\end_layout

\begin_layout Plain Layout

        else:
\end_layout

\begin_layout Plain Layout

            populate_actual()
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

recurse()
\end_layout

\begin_layout Plain Layout

actuals.sort(key=lambda d: d['R1'])
\end_layout

\begin_layout Plain Layout

dump()
\end_layout

\end_inset


\end_layout

\end_body
\end_document
